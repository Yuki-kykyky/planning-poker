# 不活跃用户清理机制优化

## 问题描述

之前的系统会在用户1分钟没有操作后自动清除用户，这导致以下问题：
- 用户短暂离开（如接电话、上厕所）后回来发现被踢出会话
- 用户体验不佳，需要重新加入会话
- 可能影响投票结果的准确性

## 解决方案

### 新的用户清理机制

现在系统只在以下情况下才会清除用户：

1. **用户主动登出**：点击"退出"按钮
2. **用户关闭标签页**：检测到标签页关闭事件
3. **用户长时间离开**：页面隐藏10秒后自动离开（给用户重新打开标签页的时间）

### 技术实现

#### 后端修改

1. **新增 `removeUserFromSession` 方法**
   - 在 `RedisSessionStore` 和内存版本的 `session-store` 中添加
   - 直接从会话中移除指定用户
   - 如果移除的是主持人，自动转移主持人权限给第一个参与者

2. **新增 `leaveSession` API**
   - 在 `app/actions.ts` 中添加
   - 支持开发和生产环境的不同实现

3. **移除基于时间的不活跃检测**
   - 移除 `getSession` 方法中的时间检测逻辑
   - 移除 `cleanupExpiredSessions` 中的不活跃用户清理
   - 只清理完全没有用户的空会话

#### 前端修改

1. **标签页关闭检测**
   - 监听 `beforeunload`、`pagehide`、`visibilitychange` 事件
   - 页面隐藏10秒后自动离开会话
   - 页面重新可见时取消自动离开

2. **登出逻辑优化**
   - 修改 `handleLogout` 方法，直接调用 `leaveSession`
   - 移除主持人权限转移逻辑（现在由后端自动处理）

### 用户体验改进

1. **更友好的离开机制**
   - 用户不会因为短暂离开而被踢出
   - 给用户足够的时间重新打开标签页
   - 只有真正离开的用户才会被清除

2. **自动主持人转移**
   - 主持人离开时自动转移权限
   - 无需手动处理权限转移

3. **更稳定的会话状态**
   - 减少因网络问题导致的误判
   - 提高会话的稳定性

## 测试建议

1. **基本功能测试**
   - 创建会话并加入多个用户
   - 测试投票、显示、重置功能
   - 验证主持人权限转移

2. **离开机制测试**
   - 测试点击退出按钮
   - 测试关闭标签页
   - 测试页面隐藏后重新打开

3. **边界情况测试**
   - 主持人离开时的权限转移
   - 最后一个用户离开时的会话清理
   - 网络断开重连的情况

## 兼容性

- 保持与现有API的兼容性
- 支持开发和生产环境
- 不影响现有的投票和会话管理功能 